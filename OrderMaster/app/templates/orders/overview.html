{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>订单总览</h1>
    <div>
        <div class="btn-group me-2">
            <a href="{{ url_for('orders.overview', status='active') }}" class="btn btn-outline-primary {{ 'active' if status_filter == 'active' else '' }}">持仓中</a>
            <a href="{{ url_for('orders.overview', status='exited') }}" class="btn btn-outline-primary {{ 'active' if status_filter == 'exited' else '' }}">已出场</a>
        </div>
        {% if is_decision_maker %}
        <a href="{{ url_for('orders.new_contract') }}" class="btn btn-primary">新增合约</a>
        {% endif %}
    </div>
</div>

<!-- 添加调试信息 -->
<div class="alert alert-info">
    当前用户角色: {{ current_user.role }}
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>合约名称</th>
                <th>周期</th>
                <th>止损金额</th>
                <th>进场时间</th>
                <th>升周期时间</th>
                <th>均线价格</th>
                <th>最高/最低价</th>
                <th>实际进场价</th>
                <th>止损价格</th>
                <th>布林周期</th>
                <th>出场时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for contract in contracts %}
            <tr class="contract-row" data-contract-id="{{ contract.id }}">
                <td>
                    <button class="btn btn-sm btn-link toggle-accounts" data-contract-id="{{ contract.id }}">
                        <i class="fas fa-plus"></i>
                    </button>
                    {{ contract.contract_name }}
                </td>
                <td>{{ contract.period }}</td>
                <td>{{ "%.2f"|format(contract.stop_loss_amount) }}</td>
                <td>{{ contract.entry_time }}</td>
                <td>{{ contract.period_upgrade_time }}</td>
                <td>{{ "%.4f"|format(contract.ma_price) if contract.ma_price else '-' }}</td>
                <td>{{ "%.4f"|format(contract.price) if contract.price else '-' }}</td>
                <td>{{ "%.4f"|format(contract.actual_entry_price) if contract.actual_entry_price else '-' }}</td>
                <td>{{ "%.4f"|format(contract.stop_loss_price) if contract.stop_loss_price else '-' }}</td>
                <td>{{ contract.bollinger_period }}</td>
                <td>{{ contract.exit_time.strftime('%Y-%m-%d %H:%M') if contract.exit_time else '-' }}</td>
                <td>
                    {% if is_decision_maker %}
                    <div class="btn-group">
                        {% if contract.can_edit %}
                        <a href="{{ url_for('orders.edit_contract', contract_id=contract.id) }}" 
                           class="btn btn-sm btn-outline-primary">修改</a>
                        {% else %}
                        <button class="btn btn-sm btn-outline-secondary" disabled title="有订单已执行，无法修改">修改</button>
                        {% endif %}
                        <a href="{{ url_for('orders.contract_accounts', contract_id=contract.id) }}" 
                           class="btn btn-sm btn-outline-info">关联账号</a>
                    </div>
                    {% endif %}
                </td>
            </tr>
            <tr class="account-details-row" id="accounts-{{ contract.id }}" style="display: none;">
                <td colspan="11">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>账户名称</th>
                                    <th>账户类型</th>
                                    <th>创建时间</th>
                                    <th>进场时间</th>
                                    <th>订单状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in contract.orders %}
                                <tr>
                                    <td>{{ order.account_name }}</td>
                                    <td>{{ order.account_type }}</td>
                                    <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ order.entry_time.strftime('%Y-%m-%d %H:%M') if order.entry_time else '-' }}</td>
                                    <td>
                                        <span class="badge {{ 
                                            'bg-warning' if order.status == 'pending' 
                                            else 'bg-info' if order.status == 'executed' 
                                            else 'bg-secondary' 
                                        }}">
                                            {{ 
                                                '待执行' if order.status == 'pending' 
                                                else '已执行' if order.status == 'executed' 
                                                else '已出场' 
                                            }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if order.status == 'pending' and current_user.role == 'executor' %}
                                        <button class="btn btn-sm btn-success execute-order" 
                                                data-order-id="{{ order.id }}"
                                                onclick="executeOrder({{ order.id }})">执行</button>
                                        {% elif order.status == 'executed' and current_user.role == 'executor' %}
                                        <button class="btn btn-sm btn-warning exit-order" 
                                                data-order-id="{{ order.id }}"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#exitOrderModal"
                                                onclick="prepareExitOrder({{ order.id }})">出场</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="11" class="text-center">暂无合约数据</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 处理展开/折叠功能
    document.querySelectorAll('.toggle-accounts').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const contractId = this.dataset.contractId;
            const detailsRow = document.getElementById(`accounts-${contractId}`);
            const icon = this.querySelector('i');
            
            if (detailsRow.style.display === 'none') {
                detailsRow.style.display = 'table-row';
                icon.classList.remove('fa-plus');
                icon.classList.add('fa-minus');
            } else {
                detailsRow.style.display = 'none';
                icon.classList.remove('fa-minus');
                icon.classList.add('fa-plus');
            }
        });
    });
});

// 执行订单
function executeOrder(orderId) {
    if (!confirm('确定要执行该订单吗？')) {
        return;
    }
    
    fetch(`/orders/order/${orderId}/execute`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '执行失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('执行失败');
    });
}

// 准备出场订单
function prepareExitOrder(orderId) {
    document.getElementById('exitOrderId').value = orderId;
}

// 提交出场订单
function submitExitOrder() {
    const orderId = document.getElementById('exitOrderId').value;
    const exitPrice = document.getElementById('exitPrice').value;
    
    if (!exitPrice) {
        alert('请输入出场价格');
        return;
    }
    
    fetch(`/orders/order/${orderId}/exit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `exit_price=${exitPrice}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '出场失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('出场失败');
    });
}
</script>

<!-- 出场订单模态框 -->
<div class="modal fade" id="exitOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">订单出场</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="exitOrderId">
                <div class="mb-3">
                    <label for="exitPrice" class="form-label">出场价格</label>
                    <input type="number" class="form-control" id="exitPrice" step="0.0001" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitExitOrder()">确认出场</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% endblock %}